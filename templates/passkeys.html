{% extends "base.html" %}

{% block title %}Passkey Management - Lala Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2"><i class="bi bi-fingerprint"></i> Passkey Management</h1>
    <button class="btn btn-primary" onclick="registerPasskey()">
        <i class="bi bi-plus-circle"></i> Register New Passkey
    </button>
</div>

<div class="card">
    <div class="card-body">
        <h5 class="card-title">Your Passkeys</h5>
        <p class="text-muted">Passkeys allow you to sign in without a password using biometrics, security keys, or your device's authentication.</p>
        
        <div id="passkey-status" class="mb-3"></div>
        
        {% if credentials %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Device Type</th>
                        <th>Created</th>
                        <th>Last Used</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="passkeys-table">
                    {% for cred in credentials %}
                    <tr data-credential-id="{{ cred['credential_id'] }}">
                        <td>
                            <i class="bi bi-fingerprint text-primary"></i>
                            <span class="credential-name">{{ cred['name'] or 'Unnamed Passkey' }}</span>
                        </td>
                        <td>
                            {% if cred['device_type'] == 'platform' %}
                            <span class="badge bg-info">Platform</span>
                            {% else %}
                            <span class="badge bg-secondary">Cross-Platform</span>
                            {% endif %}
                        </td>
                        <td><small>{{ cred['created_at'] }}</small></td>
                        <td><small>{{ cred['last_used_at'] or 'Never' }}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="renamePasskey('{{ cred['credential_id'] }}', '{{ cred['name'] }}')">
                                <i class="bi bi-pencil"></i> Rename
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePasskey('{{ cred['credential_id'] }}', '{{ cred['name'] }}')">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> You haven't registered any passkeys yet. Click "Register New Passkey" to add one.
        </div>
        {% endif %}
    </div>
</div>

<div class="card mt-4">
    <div class="card-body">
        <h5 class="card-title"><i class="bi bi-shield-check"></i> About Passkeys</h5>
        <ul>
            <li><strong>More secure:</strong> Passkeys use public-key cryptography, making them resistant to phishing attacks.</li>
            <li><strong>Convenient:</strong> Sign in using biometrics (fingerprint, Face ID), your device PIN, or a security key.</li>
            <li><strong>Cross-platform:</strong> You can use passkeys across different devices and browsers.</li>
            <li><strong>Privacy-focused:</strong> Your biometric data never leaves your device.</li>
        </ul>
        <p class="mb-0"><small class="text-muted">Supported on modern browsers including Chrome 108+, Safari 16+, Firefox 119+, and Edge 108+.</small></p>
    </div>
</div>

<script>
// Register new passkey
async function registerPasskey() {
    const statusDiv = document.getElementById('passkey-status');
    
    // Check if WebAuthn is supported
    if (!window.PublicKeyCredential) {
        statusDiv.innerHTML = '<div class="alert alert-danger">Passkeys are not supported in this browser</div>';
        return;
    }
    
    // Prompt for passkey name
    const name = prompt('Enter a name for this passkey (e.g., "My iPhone", "YubiKey"):');
    if (!name || !name.trim()) {
        return;
    }
    
    try {
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="spinner-border spinner-border-sm me-2"></i>Preparing registration...</div>';
        
        // Begin registration
        const beginResponse = await fetchWithCsrf('/passkey/register/begin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        
        const beginData = await beginResponse.json();
        
        if (!beginData.success) {
            throw new Error(beginData.error || 'Failed to begin registration');
        }
        
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="spinner-border spinner-border-sm me-2"></i>Follow the prompts on your device...</div>';
        
        // Convert options for WebAuthn API
        const options = beginData.options;
        options.challenge = base64urlToBuffer(options.challenge);
        options.user.id = base64urlToBuffer(options.user.id);
        if (options.excludeCredentials) {
            options.excludeCredentials = options.excludeCredentials.map(cred => ({
                ...cred,
                id: base64urlToBuffer(cred.id)
            }));
        }
        
        // Create credential
        const credential = await navigator.credentials.create({ publicKey: options });
        
        // Prepare credential for server
        const credentialJSON = {
            id: credential.id,
            rawId: bufferToBase64url(credential.rawId),
            response: {
                attestationObject: bufferToBase64url(credential.response.attestationObject),
                clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                transports: credential.response.getTransports ? credential.response.getTransports() : []
            },
            type: credential.type,
            name: name.trim()
        };
        
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="spinner-border spinner-border-sm me-2"></i>Verifying registration...</div>';
        
        // Complete registration
        const completeResponse = await fetchWithCsrf('/passkey/register/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(credentialJSON)
        });
        
        const completeData = await completeResponse.json();
        
        if (!completeData.success) {
            throw new Error(completeData.error || 'Registration failed');
        }
        
        statusDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>Passkey registered successfully!</div>';
        
        // Reload page to show new passkey
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('Passkey registration error:', error);
        statusDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>${error.message}</div>`;
    }
}

// Delete passkey
async function deletePasskey(credentialId, name) {
    if (!confirm(`Are you sure you want to delete "${name || 'this passkey'}"?`)) {
        return;
    }
    
    const statusDiv = document.getElementById('passkey-status');
    
    try {
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="spinner-border spinner-border-sm me-2"></i>Deleting passkey...</div>';
        
        const response = await fetchWithCsrf('/passkey/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ credential_id: credentialId })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to delete passkey');
        }
        
        statusDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>Passkey deleted successfully!</div>';
        
        // Remove row from table
        const row = document.querySelector(`tr[data-credential-id="${credentialId}"]`);
        if (row) {
            row.remove();
        }
        
        // Hide status after 3 seconds
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 3000);
        
    } catch (error) {
        console.error('Passkey delete error:', error);
        statusDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>${error.message}</div>`;
    }
}

// Rename passkey
async function renamePasskey(credentialId, currentName) {
    const newName = prompt('Enter a new name for this passkey:', currentName || '');
    if (!newName || !newName.trim() || newName === currentName) {
        return;
    }
    
    const statusDiv = document.getElementById('passkey-status');
    
    try {
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="spinner-border spinner-border-sm me-2"></i>Renaming passkey...</div>';
        
        const response = await fetchWithCsrf('/passkey/rename', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ credential_id: credentialId, name: newName.trim() })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Failed to rename passkey');
        }
        
        statusDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>Passkey renamed successfully!</div>';
        
        // Update name in table
        const row = document.querySelector(`tr[data-credential-id="${credentialId}"] .credential-name`);
        if (row) {
            row.textContent = newName.trim();
        }
        
        // Hide status after 3 seconds
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 3000);
        
    } catch (error) {
        console.error('Passkey rename error:', error);
        statusDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>${error.message}</div>`;
    }
}

// Helper functions for base64url encoding/decoding
function base64urlToBuffer(base64url) {
    const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
    const padLen = (4 - (base64.length % 4)) % 4;
    const padded = base64 + '='.repeat(padLen);
    const binary = atob(padded);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
    }
    return bytes.buffer;
}

function bufferToBase64url(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.length; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    const base64 = btoa(binary);
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}
</script>
{% endblock %}
