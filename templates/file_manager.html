{% extends "base.html" %}

{% block title %}File Manager - Lala Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">
        <i class="bi bi-folder"></i> File Manager
    </h1>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
</div>

<div class="row">
    <div class="col-lg-3 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list"></i> Select Site</h5>
            </div>
            <div class="card-body p-0">
                {% if sites %}
                <div class="list-group list-group-flush">
                    {% for site in sites %}
                    <a href="#" class="list-group-item list-group-item-action site-selector" 
                       data-site-id="{{ site['id'] }}" data-site-domain="{{ site['domain'] }}">
                        <i class="bi bi-globe"></i> {{ site['domain'] }}
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-3 text-center text-muted">
                    <p>No sites available</p>
                    <a href="{{ url_for('create_site') }}" class="btn btn-sm btn-primary">Create Site</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-9">
        <div class="card" id="file-browser" style="display: none;">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-folder-open"></i> 
                        <span id="current-site">Select a site</span>
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-primary" id="upload-btn">
                            <i class="bi bi-upload"></i> Upload
                        </button>
                        <button class="btn btn-sm btn-primary" id="new-folder-btn">
                            <i class="bi bi-folder-plus"></i> New Folder
                        </button>
                    </div>
                </div>
                <div class="mt-2">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0" id="breadcrumb">
                            <li class="breadcrumb-item active">htdocs</li>
                        </ol>
                    </nav>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="loading" class="text-center p-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="file-list-container">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="file-list">
                            <thead>
                                <tr>
                                    <th width="50%">Name</th>
                                    <th width="15%">Size</th>
                                    <th width="20%">Modified</th>
                                    <th width="15%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Files will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="empty-state" class="text-center p-5" style="display: none;">
                    <i class="bi bi-folder2-open display-1 text-muted"></i>
                    <p class="text-muted mt-3">This folder is empty</p>
                </div>
            </div>
        </div>
        
        <div class="card" id="welcome-card">
            <div class="card-body text-center p-5">
                <i class="bi bi-folder display-1 text-muted mb-3"></i>
                <h4>File Manager</h4>
                <p class="text-muted">Select a site from the left to browse and manage files</p>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="upload-file" class="form-label">Choose File</label>
                        <input type="file" class="form-control" id="upload-file" name="file" required>
                    </div>
                    <div id="upload-progress" class="progress" style="display: none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="upload-submit">Upload</button>
            </div>
        </div>
    </div>
</div>

<!-- New Folder Modal -->
<div class="modal fade" id="newFolderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="new-folder-form">
                    <div class="mb-3">
                        <label for="folder-name" class="form-label">Folder Name</label>
                        <input type="text" class="form-control" id="folder-name" 
                               name="folder_name" required pattern="[a-zA-Z0-9_\-\.]+">
                        <div class="form-text">Only letters, numbers, dashes, underscores, and dots allowed</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="folder-submit">Create</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentSiteId = null;
let currentPath = '';

document.addEventListener('DOMContentLoaded', function() {
    // Site selector
    document.querySelectorAll('.site-selector').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            currentSiteId = this.dataset.siteId;
            const domain = this.dataset.siteDomain;
            
            // Update active state
            document.querySelectorAll('.site-selector').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            
            // Update UI
            document.getElementById('current-site').textContent = domain;
            document.getElementById('welcome-card').style.display = 'none';
            document.getElementById('file-browser').style.display = 'block';
            
            // Load root directory
            currentPath = '';
            loadDirectory('');
        });
    });
    
    // Upload button
    document.getElementById('upload-btn').addEventListener('click', function() {
        if (!currentSiteId) return;
        new bootstrap.Modal(document.getElementById('uploadModal')).show();
    });
    
    // New folder button
    document.getElementById('new-folder-btn').addEventListener('click', function() {
        if (!currentSiteId) return;
        new bootstrap.Modal(document.getElementById('newFolderModal')).show();
    });
    
    // Upload submit
    document.getElementById('upload-submit').addEventListener('click', function() {
        if (!currentSiteId) return;
        
        const form = document.getElementById('upload-form');
        const fileInput = document.getElementById('upload-file');
        
        if (!fileInput.files.length) {
            alert('Please select a file');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('path', currentPath);
        
        const progressBar = document.querySelector('#upload-progress .progress-bar');
        document.getElementById('upload-progress').style.display = 'block';
        progressBar.style.width = '50%';
        
        fetch(`/files/upload/${currentSiteId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                form.reset();
                document.getElementById('upload-progress').style.display = 'none';
                loadDirectory(currentPath);
            } else {
                alert('Upload failed: ' + data.error);
                document.getElementById('upload-progress').style.display = 'none';
            }
        })
        .catch(error => {
            alert('Upload failed: ' + error);
            document.getElementById('upload-progress').style.display = 'none';
        });
    });
    
    // New folder submit
    document.getElementById('folder-submit').addEventListener('click', function() {
        if (!currentSiteId) return;
        
        const form = document.getElementById('new-folder-form');
        const folderName = document.getElementById('folder-name').value;
        
        if (!folderName) {
            alert('Please enter a folder name');
            return;
        }
        
        const formData = new FormData();
        formData.append('path', currentPath);
        formData.append('folder_name', folderName);
        
        fetch(`/files/create-folder/${currentSiteId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('newFolderModal')).hide();
                form.reset();
                loadDirectory(currentPath);
            } else {
                alert('Failed to create folder: ' + data.error);
            }
        })
        .catch(error => {
            alert('Failed to create folder: ' + error);
        });
    });
});

function loadDirectory(path) {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('file-list-container').style.display = 'none';
    document.getElementById('empty-state').style.display = 'none';
    
    fetch(`/files/browse/${currentSiteId}?path=${encodeURIComponent(path)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            currentPath = data.path;
            updateBreadcrumb(data.path);
            renderFileList(data.items);
            
            document.getElementById('loading').style.display = 'none';
            if (data.items.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
            } else {
                document.getElementById('file-list-container').style.display = 'block';
            }
        })
        .catch(error => {
            alert('Error loading directory: ' + error);
            document.getElementById('loading').style.display = 'none';
        });
}

function updateBreadcrumb(path) {
    const breadcrumb = document.getElementById('breadcrumb');
    breadcrumb.innerHTML = '<li class="breadcrumb-item"><a href="#" onclick="loadDirectory(\'\'); return false;">htdocs</a></li>';
    
    if (path) {
        const parts = path.split('/');
        let accumulatedPath = '';
        
        parts.forEach((part, index) => {
            if (!part) return;
            accumulatedPath += (accumulatedPath ? '/' : '') + part;
            const isLast = index === parts.length - 1;
            
            if (isLast) {
                breadcrumb.innerHTML += `<li class="breadcrumb-item active">${escapeHtml(part)}</li>`;
            } else {
                const pathToUse = accumulatedPath;
                breadcrumb.innerHTML += `<li class="breadcrumb-item"><a href="#" onclick="loadDirectory('${escapeHtml(pathToUse)}'); return false;">${escapeHtml(part)}</a></li>`;
            }
        });
    }
}

function renderFileList(items) {
    const tbody = document.querySelector('#file-list tbody');
    tbody.innerHTML = '';
    
    // Sort: directories first, then by name
    items.sort((a, b) => {
        if (a.is_dir && !b.is_dir) return -1;
        if (!a.is_dir && b.is_dir) return 1;
        return a.name.localeCompare(b.name);
    });
    
    items.forEach(item => {
        const row = document.createElement('tr');
        
        const icon = item.is_dir ? 'bi-folder-fill' : 'bi-file-earmark';
        const nameCell = `
            <td>
                <i class="bi ${icon}"></i>
                ${item.is_dir ? 
                    `<a href="#" onclick="loadDirectory('${escapeHtml(item.path)}'); return false;">${escapeHtml(item.name)}</a>` :
                    `<span>${escapeHtml(item.name)}</span>`
                }
            </td>
        `;
        
        const sizeCell = `<td>${item.is_dir ? '-' : formatBytes(item.size)}</td>`;
        const modifiedCell = `<td>${escapeHtml(item.modified)}</td>`;
        
        const actionsCell = `
            <td>
                ${!item.is_dir ? 
                    `<a href="/files/download/${currentSiteId}?path=${encodeURIComponent(item.path)}" 
                        class="btn btn-sm btn-outline-primary" title="Download">
                        <i class="bi bi-download"></i>
                    </a>` : 
                    ''
                }
                <button onclick="deleteItem('${escapeHtml(item.path)}', ${item.is_dir})" 
                        class="btn btn-sm btn-outline-danger" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        row.innerHTML = nameCell + sizeCell + modifiedCell + actionsCell;
        tbody.appendChild(row);
    });
}

function deleteItem(path, isDir) {
    const itemType = isDir ? 'folder' : 'file';
    if (!confirm(`Are you sure you want to delete this ${itemType}?`)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('path', path);
    
    fetch(`/files/delete/${currentSiteId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadDirectory(currentPath);
        } else {
            alert('Delete failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('Delete failed: ' + error);
    });
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

<style>
.list-group-item {
    background-color: var(--bg-secondary);
    border-color: var(--border-color);
    color: var(--text-primary);
}

.list-group-item:hover {
    background-color: var(--bg-tertiary);
    color: var(--text-primary);
}

.list-group-item.active {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    color: white;
}

.breadcrumb {
    background-color: var(--bg-tertiary);
    margin-bottom: 0;
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
}

.breadcrumb-item a {
    color: var(--accent-color);
    text-decoration: none;
}

.breadcrumb-item a:hover {
    text-decoration: underline;
}

.breadcrumb-item.active {
    color: var(--text-primary);
}

.breadcrumb-item + .breadcrumb-item::before {
    color: var(--text-secondary);
}

.progress {
    background-color: var(--bg-tertiary);
}

.spinner-border {
    color: var(--accent-color);
}
</style>
{% endblock %}
